name: Update NHANES Data

on:
  # Quarterly schedule: 1st day of Jan/Apr/Jul/Oct at 2 AM UTC
  schedule:
    - cron: '0 2 1 1,4,7,10 *'

  # Manual trigger with optional parameters
  workflow_dispatch:
    inputs:
      datasets:
        description: 'Comma-separated list of datasets to update (leave empty for all)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (skip R2 upload)'
        required: false
        type: boolean
        default: false

# Limit concurrent executions to prevent conflicts
concurrency:
  group: nhanes-data-update
  cancel-in-progress: false

# Minimize permissions (principle of least privilege)
permissions:
  contents: write  # Needed to commit updated checksums
  actions: read

jobs:
  update-data:
    name: Pull CDC Data & Upload to R2
    runs-on: ubuntu-latest

    # Timeout after 6 hours (some datasets are large)
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper git operations

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::remotes
            any::jsonlite
            any::yaml
          cache-version: 2

      - name: Install nhanesdata package
        run: |
          remotes::install_local(".", dependencies = TRUE, force = TRUE)
        shell: Rscript {0}

      - name: Verify R2 credentials
        if: ${{ !inputs.dry_run }}
        run: |
          if [ -z "${{ secrets.R2_ACCOUNT_ID }}" ]; then
            echo "ERROR: R2_ACCOUNT_ID secret not set"
            exit 1
          fi
          if [ -z "${{ secrets.R2_ACCESS_KEY_ID }}" ]; then
            echo "ERROR: R2_ACCESS_KEY_ID secret not set"
            exit 1
          fi
          if [ -z "${{ secrets.R2_SECRET_ACCESS_KEY }}" ]; then
            echo "ERROR: R2_SECRET_ACCESS_KEY secret not set"
            exit 1
          fi
          echo "All R2 credentials verified"
        shell: bash

      - name: Create data directories
        run: |
          mkdir -p data/raw/R
          mkdir -p data/raw/parquet
        shell: bash

      - name: Run workflow update script
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          # Build command with optional arguments
          CMD="Rscript inst/scripts/workflow_update.R"

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            CMD="$CMD --dry-run"
          fi

          if [ -n "${{ inputs.datasets }}" ]; then
            CMD="$CMD --datasets=${{ inputs.datasets }}"
          fi

          echo "Executing: $CMD"
          $CMD
        shell: bash

      - name: Upload workflow summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-summary-${{ github.run_number }}
          path: workflow_summary.json
          retention-days: 90

      - name: Commit updated checksums
        if: ${{ !inputs.dry_run }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if checksums file changed
          if git diff --quiet .checksums.json; then
            echo "No checksum changes to commit"
          else
            git add .checksums.json
            git commit -m "$(cat <<'EOF'
          chore: update data checksums after quarterly CDC pull

          Automated data update from GitHub Actions workflow.
          Run: ${{ github.run_number }}
          Triggered: ${{ github.event_name }}
          Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          See workflow summary artifact for details on changed datasets.

          ðŸ¤– Generated with GitHub Actions
          EOF
          )"
            git push
            echo "Checksums committed and pushed"
          fi
        shell: bash

      - name: Create release notes
        if: ${{ !inputs.dry_run && success() }}
        run: |
          # Read summary file
          if [ -f workflow_summary.json ]; then
            echo "## NHANES Data Update - $(date -u +"%Y-%m-%d")" > release_notes.md
            echo "" >> release_notes.md
            echo "### Summary" >> release_notes.md

            # Extract key metrics using jq
            CHANGED=$(jq -r '.datasets_changed' workflow_summary.json)
            UPLOADED=$(jq -r '.datasets_uploaded' workflow_summary.json)
            FAILED=$(jq -r '.datasets_failed' workflow_summary.json)

            echo "- Changed datasets: $CHANGED" >> release_notes.md
            echo "- Uploaded to R2: $UPLOADED" >> release_notes.md
            echo "- Failed: $FAILED" >> release_notes.md
            echo "" >> release_notes.md

            # List changed datasets
            if [ "$CHANGED" -gt 0 ]; then
              echo "### Changed Datasets" >> release_notes.md
              jq -r '.changed_datasets[]' workflow_summary.json | while read ds; do
                echo "- \`$ds\`" >> release_notes.md
              done
              echo "" >> release_notes.md
            fi

            echo "### Access Data" >> release_notes.md
            echo "All datasets available at: https://nhanes.kylegrealis.com/" >> release_notes.md
            echo "" >> release_notes.md
            echo "**R Usage:**" >> release_notes.md
            echo '```r' >> release_notes.md
            echo 'library(nhanesdata)' >> release_notes.md
            echo 'demo <- read_nhanes("demo")' >> release_notes.md
            echo '```' >> release_notes.md

            cat release_notes.md
          fi
        shell: bash

      - name: Upload release notes
        if: ${{ !inputs.dry_run && success() }}
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ github.run_number }}
          path: release_notes.md
          retention-days: 90

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::NHANES data update workflow failed"
          echo "::error::Check the workflow summary artifact for details"

          if [ -f workflow_summary.json ]; then
            FAILED=$(jq -r '.failed_datasets[]' workflow_summary.json 2>/dev/null || echo "")
            if [ -n "$FAILED" ]; then
              echo "::error::Failed datasets: $FAILED"
            fi
          fi
        shell: bash
